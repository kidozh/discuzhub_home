# 前言

我們收到部分論壇管理員的來信，希望我們能定制一款專屬於他們論壇的應用。由於工作的繁忙以及安全問題，我們並未對此要求進行正面的答复。經過我們的測試和適配，我們很高興的宣佈在Discuz Hub 3.10版本後，我們支持了專屬論壇的編譯以及發布。

# 使用許可

您需要同意下列條款以分發專屬於單一論壇的應用

+ [隱私政策](/privacy_policy)
+ [使用條款](/term_of_use)

<Alert>我們理解到部分用戶很少閱讀條款，但是我們希望您瀏覽一次，以避免不必要的爭端。 </Alert>

# 注意

此教程將會幫助你在本地構建應用，您也可以使用Gitub Action構建本應用，詳情請點擊[使用GitHub action構建應用](/customize-bbs-in-github/)

其對比的優劣在於:

| | 本地構建 | Github action |
| ---- | ---- | ---- |
| 靈活性 | 高，可以進行源代碼修改 | 低 |
| 安全性 | √√√ | √√√√ |
| 更新方式 | Git merge或者下載源代碼 | Git merge |
| 構建速度 | 視電腦配置和網絡情況而定，在內地可能預料到非常的緩慢 | 快，約4分鐘左右 |
| 額外費用 | 無 | 當超出Github時間限制時，可能會收取一定費用，相關情況請點擊[Github Pricing](https://github.com/pricing) |
| 需要Github賬號 | 否 | 是 |

# 舉例說明

在接下來的內容中，我們謹以QZZN論壇為例，向你闡述如何分發自己論壇的專屬應用。

QZZN論壇的網址是：[https://bbs.qzzn.com/](https://bbs.qzzn.com/)

<Message>我們，DiscuzHub，與QZZN論壇之間並無任何联系。相關功能不為任何個人及組織擔保。詳細信息請檢查我們的使用條款。 </Message>

# 技術要求

你需要達到以下要求以完成對於專屬應用的編譯以及發布

+ 一台支持Android studio的計算機
+ [Android studio](https://developer.android.com/studio)（大陸地區可以使用Google.cn開發者網站下載[https://developer.android.google.cn/studio](https:// developer.android.google.cn/studio)）
+ Git或者能夠解壓Zip壓縮文件的軟件

<Message>當您處於中國大陸區域時，從Android studio官網上下載可能非常緩慢。您可以使用Google中國開發者網站下載以獲得更好的速度。 </Message>

# 準備

首先，你需要下載我們的Discuz Hub源代碼。你可以使用：

+ git命令下載
+ 從Github上下載zip打包的源代碼

<Message>當您處於中國大陸區域時，使用Github下載可能非常緩慢。您可以使用代理服務以加速此過程。 </Message>

## 使用git命令

打開您的終端（Windows用戶使用Win徽標鍵+R，在彈出的運行對話框中鍵入cmd並選擇確定）

使用`cd`命令進入你想存放代碼的文件夾

### 使用HTTPS

```bash
git clone https://github.com/kidozh/DiscuzHub.git
```

### 使用SSH

```bash
git clone git@github.com:kidozh/DiscuzHub.git
```

### 使用Github CLI

```bash
gh repo clone kidozh/DiscuzHub
```

等待終端執行命令後，完成Discuz源碼的下載

### 直接下載源碼

使用瀏覽器打開我們的庫：[https://github.com/kidozh/DiscuzHub](https://github.com/kidozh/DiscuzHub)，點擊Code按鈕，點擊Download ZIP，等待下載完成。

![使用Github下載源代碼](/images/download_from_github.png)

將下載的源代碼（文件名可能是DiscuzHub-master.zip）解壓到您存放源代碼的文件夾

這樣你就完成了對於源代碼的下載。接著你需要開始使用Android studio這個官方IDE編譯此應用。

# 使用並安裝Android studio

從[Android studio](https://developer.android.com/studio)（大陸地區[https://developer.android.google.cn/studio](https://developer.android.google.cn/studio )）安裝好應用後，你可能需要設置或下載一系列的軟件和插件以能夠編譯Android應用。

我們的工程目前是支持Android 11版本的，請選擇並下載此版本的SDK以完成編譯。

使用Android studio打開存放源代碼的文件夾。

# 自定義參數

我們的使用條款明確表明，使用我們的服務並不意味著您可以使用我們的圖標，同時您的衍生服務也不應當乾擾我們的正常服務，因此，您必須修改下面的內容以滿足協議：

## 1. 修改應用名稱

請在AndroidManifest.xml（路徑：`app\src\main\AndroidManifest.xml`）文件中，修改application目錄下的android:label這個值為您論壇的名稱。例如android:label="QZZN論壇"

```xml{numberLines: 17}
    <application
        android:allowBackup="true"
        android:icon="@mipmap/logo"
        android:label="QZZN論壇" // highlight-line
        android:networkSecurityConfig="@xml/network_security_config"
        android:supportsRtl="true"
        android:theme="@style/AppTheme.Default"
        tools:ignore="GoogleAppIndexingWarning"
        tools:targetApi="n">
```

### 國際化需求

我們理解到部分論壇可能具有國際化任務的需求，那麼請維持AndroidManifest.xml文件的android:label這個值，轉而修改string.xml文件的app_name這個值。我們謹以**keylol.com**為例子。

**keylol.com**中文名稱為其樂，英文名稱為keylol。

在默認英文字符串文件（strings.xml，路徑`app\src\main\res\values\strings.xml`）中修改app_name為keylol，在中文字符串文件（src\main\res\values-zh- rCN\strings.xml）中修改app_name值為其樂。

```xml{numberLines: 17}
    <application
        android:allowBackup="true"
        android:icon="@mipmap/logo"
        android:label="@string/app_name" // highlight-line
        android:networkSecurityConfig="@xml/network_security_config"
        android:supportsRtl="true"
        android:theme="@style/AppTheme.Default"
        tools:ignore="GoogleAppIndexingWarning"
        tools:targetApi="n">
```

<Alert>我們，DiscuzHub，與其樂論壇（keylol.com）之間並無任何联系。 </Alert>

## 2. 修改應用ID

應用ID相當於應用的身份證，一個應用應當只有一個ID。當相同的ID安裝時，將會發生覆蓋的情況，並且會干擾應用的運行。根據我們的使用條款且為了您的分發便利，您不應當使用我們的應用ID而應當轉而使用自己的ID。我們以QZZN為例，其論壇使用的域名為bbs.qzzn.com，那麼根據Google開發者指南推薦，你可以使用**com.qzzn.bbs**為應用ID。

在模塊的Gradle文件中，修改android選項下的**defaultConfig**中的**applicationId**為 **"com.qzzn.bbs"** ，示例如下：

```groovy{numberLines: 5}
android {
    compileSdkVersion 30
    buildToolsVersion "29.0.3"
    defaultConfig {
        applicationId "com.qzzn.bbs" // highlight-line
        minSdkVersion 23
        targetSdkVersion 30
        versionCode 31
        versionName "3.10"
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        manifestPlaceholders = [
                discuz_title: "NOT_IMPLEMENTED",
                discuz_base_url: "NOT_IMPLEMENTED",
        ]
    }
    ...
}
```

這樣你就完成了applicationId的修改。

## 修改構建類型的值

在項目的gradle文件（相對路徑：`app/build.gradle`）下，我們提供了不同的構建類型，其對應著不同的分發版本，有著不同的功能

+ **single**：這個就是專屬論壇使用的構建類型，在分發時，您應當選擇此構建類型構建自己的應用並分發
+ release: 這個是我們分發Discuz Hub應用時的構建源，其支持多個論壇同時使用，這個不應當用於構建專屬論壇。
+ debug：調試內容，這個不應用於生產環境
+ qzzn：一個以qzzn論壇為例的構建類型

請修改`single`下的**discuz_title**以及**discuz_base_url**兩個值。

```groovy{numberLines: 32}
        single {
            // fill your bbs id
            manifestPlaceholders = [
                    discuz_title: "論壇名稱（如：西北工業大學三行四方）", // highlight-line
                    discuz_base_url: "服務網址（如：https://bbs.example.com）", // highlight-line
            ]
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            applicationIdSuffix ".bbs" // highlight-line
        }
```

+ discuz_title是論壇的名稱，其將會被顯示與開始頁面，最終存入數據庫的名稱將以API為準
+ discuz_base_url是論壇的網址，這個參數非常重要，有的論壇服務在域名上（如bbs.qzzn.com）,有的論壇則有一個路徑（如一畝三分地: [www.1point3acres.com/bbs ](https://www.1point3acres.com/bbs)），你應當非常注意此值。同時網址也需要給上協議（如HTTP和HTTPS）。我們的應用雖然支持跳轉，但是當你的論壇支持HTTPS協議時，請不要使用HTTP協議。
+ applicationIdSuffix會在最終的applicationId添加一個 **.bbs** 的後綴，因此最終編譯出的applicationId將會是**com.qzzn.bbs.bbs**

這樣就完成了應用的修改，接著就可以開始應用的構建了。

## 更換圖​​標

根據我們的使用政策，您不應當使用我們的圖標來分發您的應用。因此，您需要使用自己的圖標。

### 準備圖標

我們推薦您使用SVG位圖或者PNG、JPG等像素圖像作為應用圖標，尺寸大小應當是一個正方形或者類正方形。

| | SVG | PNG、JPG |
| ---- | ---- | ---- |
| 性質 | 位圖 | 像素圖 |
| 分辨率 | 接近於無限，極好 | 較差 |
| 兼容性 | 差，尤其是多圖層、圖形複雜時 | 好 |

我們理解到部分應用商店（例如小米應用商店）要求圖標是PNG格式，因此請根據您的分發渠道確定**圖標格式**。

### 使用Android Studio導入

在項目框中任一地方點擊右鍵，呼出對話框。如果是位圖SVG文件，選擇New -> Vector Asset，如果是PNG、JPG資源文件選擇New -> Image Asset。

![添加圖形資源](/images/add_drawable.png)

接下來選擇你準備好的圖片資源，選擇好後，選擇尺寸（建議100×100）

![選擇本地資源](/images/add_vector_assets.png)

點擊next完成

### 從Manifest中更改圖標

請在AndroidManifest.xml（路徑：`app\src\main\AndroidManifest.xml`）文件中，修改application目錄下的android:icon這個值為您論壇的名稱。如果是位圖則是`@drawable/剛剛生成的名字`，如果是像素則是`@mipmap/剛剛生成的名字`

```xml{numberLines: 17}
    <application
        android:allowBackup="true"
        android:icon="@mipmap/logo" // highlight-line
        android:label="@string/app_name"
        android:networkSecurityConfig="@xml/network_security_config"
        android:supportsRtl="true"
        android:theme="@style/AppTheme.Default"
        tools:ignore="GoogleAppIndexingWarning"
        tools:targetApi="n">
```

我們建議使用位圖圖像，如果你想省事的話，直接複製**PNG圖片**，替換mipmap下的logo.png(路徑：`/app/src/main/res/mipmap-xxxhdpi/logo.png` )文件即可


# 構建應用

和正常的Android程序一樣，首先你需要使用gradle構建一下整個項目。在導航欄中選擇**Build->Make Project**完成項目的構建。

![Gradle構建項目](/images/gradle_build.png)

<Alert>當您處於中國大陸區域時，使用Gradle編譯Android應用可能非常緩慢甚至報錯。您可以使用代理服務器以獲得更好的速度。 </Alert>

# 生成應用

在導航欄中選擇Build->Generate Signed Bundle or APK，打開選中的框

![生成應用](/images/build-dialog.png)

選擇你需要分發的應用類型，我們以分發APK為例，選擇APK，點擊Next。

## 選擇密鑰庫

當你首次生成安裝文件時，你需要創建一個密鑰庫（keystore）對安裝包進行加密，並驗證你的身份。如果你之前有密鑰庫，你可以選擇Choose exisiting以選擇密鑰庫。

![選擇密鑰庫](/images/generate_keystore.png)

若你沒有密鑰庫，請選擇Create New以創建新的密鑰庫。

![創造密鑰庫](/images/create_keystore.png)

填上上面的信息後，相應路徑下就會生成密鑰庫文件。

<Alert>密鑰非常重要，它是驗證發布者身份的重要憑證，請小心保管並做好備份。每次您分發應用時，都需要使用到此密鑰。當您使用不一樣的密鑰簽發同一Id應用時，將導致無法安裝的情況。 </Alert>

選擇密鑰庫並填上密鑰和密碼，點擊Next。

### 選擇構建類型

請選擇single，構建專屬於您論壇的應用。建議同時選擇上簽名版本v1和v2。點擊finish開始生成安裝包apk。

![生成安裝包](/images/generate_signed_apk.png)

等待生成完畢後，生成的APK文件就可以用於分發以及安裝。

這樣，你就完成了應用的構建

# 後語

如若你有任何問題，你可以聯繫kidozh@gmail.com以獲得幫助和支持。

<Alert variant='accent'>請注意措辭和言行，開發者並未對此功能做出任何承諾和保證，同時開發者並不是你爹。若措辭不當或者發生消息濫用的情況，我們有權停止對你的服務和支持，並撤銷使用和再分發許可。 </Alert>